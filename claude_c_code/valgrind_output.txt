==188670== Memcheck, a memory error detector
==188670== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.
==188670== Using Valgrind-3.22.0 and LibVEX; rerun with -h for copyright info
==188670== Command: ./bin/test_pruning
==188670== 
=== Testing Pruning Algorithm (Stage 4) ===
Expected C++ baseline log-likelihood: -19310.063311
Tolerance: < 1e-10 difference

Test 1: Post-order edge traversal
Number of edges in topology file is 73
Read 38 taxa from taxon order file
Found 648 patterns in file
Number of unique site patterns is 648
Packed storage memory: 9234 bytes (62.50% savings)
Number of non-root vertices is 73
Root probability (pi): [0.287675, 0.197608, 0.259430, 0.255286]
F81 mu is 1.340988
  Setting F81 matrices for 73 non-root vertices
  Set 73 matrices
  PASS: Full setup successful
  Number of leaves: 38
  First leaf: Nag (id=1, out_degree=0)
  Last leaf: Pod (id=73, out_degree=0)
  Number of post-order edges: 73
  PASS: 73 edges in post-order traversal
  PASS: First edge has leaf child
  PASS: Last edge has root as parent

Test 2: Basic pruning algorithm test
Number of edges in topology file is 73
Read 38 taxa from taxon order file
Found 648 patterns in file
Number of unique site patterns is 648
Packed storage memory: 9234 bytes (62.50% savings)
Number of non-root vertices is 73
Root probability (pi): [0.287675, 0.197608, 0.259430, 0.255286]
F81 mu is 1.340988
  Setting F81 matrices for 73 non-root vertices
  Set 73 matrices
  PASS: Full setup successful
  Number of patterns: 648
  Number of vertices: 74
  Number of observed vertices: 38
  Root: h_0 (id=0)
  Total post-order edges: 73
  Edges involving h_25 (id=42):
    Edge 25: h_25 (id=42) -> h_26 (id=49)
    Edge 26: h_25 (id=42) -> Vvi (id=43)
    Edge 27: h_24 (id=51) -> h_25 (id=42)
  Pattern 4 bases for h_25's children:
    Child Vvi (id=43, pat_idx=21): base=2
    Child h_26 (id=49): internal node
      Branch length: 0.0125360000
      Transition matrix row 0: [0.988125, 0.003294, 0.004325, 0.004256]
      Transition matrix row 1: [0.004796, 0.986624, 0.004325, 0.004256]
  Computing log-likelihood using pruning algorithm...
  Computed log-likelihood: -19310.06331508588
  PASS: Log-likelihood is negative
  PASS: Log-likelihood is not NaN
  PASS: Log-likelihood is not infinite

Test 3: CRITICAL - Validate against C++ baseline
Number of edges in topology file is 73
Read 38 taxa from taxon order file
Found 648 patterns in file
Number of unique site patterns is 648
Packed storage memory: 9234 bytes (62.50% savings)
Number of non-root vertices is 73
Root probability (pi): [0.287675, 0.197608, 0.259430, 0.255286]
F81 mu is 1.340988
  Setting F81 matrices for 73 non-root vertices
  Set 73 matrices
  PASS: Full setup successful
  C++ baseline:      -19310.06311500000
  C implementation:  -19310.06331508588
  Difference:        2.00e-04
  Tolerance:         1.00e-03
  PASS: Log-likelihood matches C++ baseline within tolerance (expected=-19310.06311500000, got=-19310.06331508588, diff=2.00e-04)

Test 4: Internal consistency checks
Number of edges in topology file is 73
Read 38 taxa from taxon order file
Found 648 patterns in file
Number of unique site patterns is 648
Packed storage memory: 9234 bytes (62.50% savings)
Number of non-root vertices is 73
Root probability (pi): [0.287675, 0.197608, 0.259430, 0.255286]
F81 mu is 1.340988
  Setting F81 matrices for 73 non-root vertices
  Set 73 matrices
  PASS: Full setup successful
  PASS: Repeated computation gives same result (expected=-19310.06331508588, got=-19310.06331508588, diff=0.00e+00)

Test 5: Scaling factors test
Number of edges in topology file is 73
Read 38 taxa from taxon order file
Found 648 patterns in file
Number of unique site patterns is 648
Packed storage memory: 9234 bytes (62.50% savings)
Number of non-root vertices is 73
Root probability (pi): [0.287675, 0.197608, 0.259430, 0.255286]
F81 mu is 1.340988
  Setting F81 matrices for 73 non-root vertices
  Set 73 matrices
  PASS: Full setup successful
  Root log scaling factor: -8.525242
  PASS: Root has non-zero scaling factor

=== Results ===
Tests passed: 14
Tests failed: 0

*** ALL TESTS PASSED ***
Stage 4 (Pruning Algorithm) VALIDATED
You may proceed to Stage 5 (Belief Propagation)
==188670== 
==188670== HEAP SUMMARY:
==188670==     in use at exit: 0 bytes in 0 blocks
==188670==   total heap usage: 133,856 allocs, 133,856 frees, 2,148,246 bytes allocated
==188670== 
==188670== All heap blocks were freed -- no leaks are possible
==188670== 
==188670== For lists of detected and suppressed errors, rerun with: -s
==188670== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
